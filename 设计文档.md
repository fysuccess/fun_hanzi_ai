# 字趣AI (FunHanzi AI) - 设计文档

**文档版本**: V1.0  
**创建日期**: 2025-11-25  
**设计师**: Antigravity AI

---

## 一、UI 设计方案

### 1.1 设计理念

**核心原则**：
- 🎨 **童趣化**：使用柔和的渐变色和圆角设计，降低学习压力
- 🎯 **聚焦性**：主视觉焦点在田字格动画，减少干扰元素
- 📱 **响应式**：移动端优先，适配手机/平板/PC
- ⚡ **高性能**：动画流畅度 60fps，加载时间 < 1s

### 1.2 色彩系统

```css
/* 主色调 - 渐变紫蓝 */
--primary-gradient: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
--primary-purple: #8B5CF6;
--primary-blue: #3B82F6;

/* 辅助色 */
--accent-yellow: #FCD34D;  /* 强调/提示 */
--accent-red: #EF4444;     /* 部首高亮 */
--accent-green: #10B981;   /* 成功反馈 */

/* 中性色 */
--bg-white: #FFFFFF;
--bg-gray-50: #F9FAFB;
--text-dark: #1F2937;
--text-gray: #6B7280;
--border-gray: #E5E7EB;
```

### 1.3 页面布局结构

#### 主页面 (Desktop - 1440px)

```
┌─────────────────────────────────────────────────────────┐
│  Header                                                  │
│  [Logo 字趣AI]        [搜索框 🔍]         [用户中心]     │
├──────────────────┬──────────────────────────────────────┤
│                  │                                       │
│  田字格动画区     │   字符信息卡片                        │
│  ┌────────────┐  │   ┌─────────────────────────────┐   │
│  │            │  │   │ 猫  māo  🔊                  │   │
│  │     猫     │  │   │ 部首: 犭  笔画: 11           │   │
│  │            │  │   └─────────────────────────────┘   │
│  └────────────┘  │                                       │
│  [重播][暂停][速度]│   AI 趣味课堂                        │
│                  │   ┌─────────────────────────────┐   │
│                  │   │ 📖 字源故事                  │   │
│                  │   │ 左边是'犭'代表动物...        │   │
│                  │   │                              │   │
│                  │   │ 💡 巧记口诀                  │   │
│                  │   │ "反犬旁，苗字边..."          │   │
│                  │   │                              │   │
│                  │   │ 📝 组词造句                  │   │
│                  │   │ 小猫 · 熊猫 · 花猫           │   │
│                  │   │ 我家的小猫喜欢在窗台上...    │   │
│                  │   └─────────────────────────────┘   │
└──────────────────┴──────────────────────────────────────┘
│  [开始练习 ✏️]                                           │
└─────────────────────────────────────────────────────────┘
```

#### 移动端布局 (375px)

```
┌─────────────────────┐
│  [Logo] [搜索] [☰]  │
├─────────────────────┤
│   猫  māo  🔊       │
│   部首: 犭  笔画: 11 │
├─────────────────────┤
│  ┌───────────────┐  │
│  │               │  │
│  │      猫       │  │
│  │               │  │
│  └───────────────┘  │
│  [重播] [暂停] [速度]│
├─────────────────────┤
│  📖 字源故事         │
│  左边是'犭'...       │
│                     │
│  💡 巧记口诀         │
│  "反犬旁..."         │
│                     │
│  📝 组词造句         │
│  小猫 · 熊猫         │
├─────────────────────┤
│  [开始练习 ✏️]       │
└─────────────────────┘
```

### 1.4 核心组件设计

#### 1. 搜索框组件
```
特性：
- 圆角设计 (border-radius: 24px)
- 阴影效果 (shadow-lg)
- 实时拼音提示
- 防抖处理 (500ms)
- 支持手写输入
```

#### 2. 田字格组件
```
规格：
- 尺寸: 300x300px (Desktop) / 280x280px (Mobile)
- 网格线: 红色 (#EF4444) 2px
- 米字辅助线: 虚线 1px
- 背景: 淡黄色 (#FFFBEB)
- 动画速度: 可调节 (0.5x - 2x)
```

#### 3. AI 内容卡片
```
布局：
- 卡片式设计 (rounded-2xl, shadow-md)
- 图标 + 标题 + 内容
- 渐变背景装饰
- 加载骨架屏 (Skeleton)
```

#### 4. 练习模式界面
```
功能：
- 描红引导线
- 实时笔迹识别
- 正确/错误反馈动画
- 进度条显示
```

### 1.5 交互动效

| 交互场景 | 动效设计 | 时长 |
|---------|---------|------|
| 搜索输入 | 搜索框放大 + 阴影加深 | 200ms |
| 笔画动画 | SVG 路径动画 (stroke-dasharray) | 800ms/笔画 |
| 按钮点击 | 缩放 (scale: 0.95) + 涟漪效果 | 150ms |
| 卡片加载 | 从下往上滑入 (translateY) | 300ms |
| 练习成功 | 烟花粒子效果 | 1500ms |
| 练习失败 | 震动 (shake) + 红色闪烁 | 500ms |

### 1.6 字体系统

```css
/* 中文字体 */
font-family: 
  "PingFang SC",      /* macOS */
  "Microsoft YaHei",  /* Windows */
  "Noto Sans SC",     /* 跨平台 */
  sans-serif;

/* 拼音字体 */
font-family: 
  "SF Pro Text",      /* macOS */
  "Segoe UI",         /* Windows */
  system-ui;

/* 代码/数字 */
font-family: 
  "JetBrains Mono",
  "Fira Code",
  monospace;
```

---

## 二、系统架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                     用户层 (Client)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ Desktop  │  │  Mobile  │  │  Tablet  │              │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘              │
└───────┼─────────────┼─────────────┼────────────────────┘
        │             │             │
        └─────────────┴─────────────┘
                      │
        ┌─────────────▼─────────────┐
        │      CDN / Vercel Edge     │ (静态资源)
        └─────────────┬─────────────┘
                      │
┌─────────────────────▼─────────────────────────────────┐
│                  前端层 (Frontend)                     │
│  ┌──────────────────────────────────────────────────┐ │
│  │            Next.js 14 (App Router)               │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐         │ │
│  │  │ Search   │ │  Hanzi   │ │   AI     │         │ │
│  │  │Component │ │ Writer   │ │ Content  │         │ │
│  │  └──────────┘ └──────────┘ └──────────┘         │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐         │ │
│  │  │   TTS    │ │ Practice │ │ History  │         │ │
│  │  │  Player  │ │   Mode   │ │   Book   │         │ │
│  │  └──────────┘ └──────────┘ └──────────┘         │ │
│  └──────────────────────────────────────────────────┘ │
└─────────────────────┬─────────────────────────────────┘
                      │ HTTPS/JSON
        ┌─────────────▼─────────────┐
        │    API Gateway Layer       │
        │  (Next.js API Routes)      │
        │  /api/character            │
        │  /api/practice             │
        │  /api/history              │
        └─────────────┬─────────────┘
                      │
        ┌─────────────▼─────────────────────────────┐
        │          业务逻辑层 (Backend)              │
        │  ┌──────────────┐  ┌──────────────┐      │
        │  │ Character    │  │  Practice    │      │
        │  │ Service      │  │  Service     │      │
        │  └──────┬───────┘  └──────┬───────┘      │
        │         │                  │              │
        │  ┌──────▼──────────────────▼───────┐     │
        │  │      Cache Manager              │     │
        │  │  (查询优化 / 防重复调用)         │     │
        │  └──────┬──────────────────────────┘     │
        └─────────┼────────────────────────────────┘
                  │
        ┌─────────▼─────────────────────────────┐
        │         数据层 (Data Layer)            │
        │  ┌──────────┐  ┌──────────────┐       │
        │  │  Redis   │  │   MongoDB    │       │
        │  │  Cache   │  │   Database   │       │
        │  │ (热数据)  │  │  (持久化)     │       │
        │  └──────────┘  └──────────────┘       │
        └────────────────────────────────────────┘
                  │
        ┌─────────▼─────────────────────────────┐
        │      外部服务层 (External Services)    │
        │  ┌──────────┐  ┌──────────────┐       │
        │  │ DeepSeek │  │ Hanzi Writer │       │
        │  │   API    │  │     CDN      │       │
        │  │ (AI生成)  │  │  (笔画数据)   │       │
        │  └──────────┘  └──────────────┘       │
        │  ┌──────────┐                         │
        │  │ Browser  │                         │
        │  │   TTS    │                         │
        │  └──────────┘                         │
        └────────────────────────────────────────┘
```

### 2.2 数据流设计

#### 场景 1: 用户查询汉字 (首次查询)

```
1. 用户输入 "猫" → 前端防抖 500ms
2. 前端发送 GET /api/character?char=猫
3. API 层接收请求
4. 查询 Redis 缓存 → Miss (未命中)
5. 查询 MongoDB → Miss (未命中)
6. 调用 DeepSeek API 生成内容 (3s)
7. 调用 pinyin-pro 获取拼音 (本地)
8. 合并数据写入 MongoDB
9. 写入 Redis (TTL: 7天)
10. 返回 JSON 给前端
11. 前端渲染:
    - HanziWriter 加载笔画数据 (1s)
    - 显示 AI 内容 (流式输出)
    - TTS 准备就绪
```

#### 场景 2: 用户查询汉字 (二次查询)

```
1. 用户输入 "猫"
2. GET /api/character?char=猫
3. 查询 Redis → Hit (命中) ✅
4. 直接返回缓存数据 (< 50ms)
5. 前端渲染
```

#### 场景 3: 用户练习模式

```
1. 用户点击 "开始练习"
2. HanziWriter.quiz() 启动测验模式
3. 用户手写笔画
4. 前端实时校验笔画顺序
5. 正确 → 绿色高亮 + 下一笔
6. 错误 → 红色闪烁 + 震动
7. 完成 → POST /api/practice (记录练习数据)
8. 显示烟花动画 + 鼓励语
```

### 2.3 技术选型详解

| 层级 | 技术 | 版本 | 理由 |
|-----|------|------|------|
| **前端框架** | Next.js | 14.x | App Router, RSC, SEO优化 |
| **UI库** | Tailwind CSS | 3.x | 快速开发, 响应式 |
| **组件库** | shadcn/ui | latest | 无依赖, 可定制 |
| **笔画引擎** | Hanzi Writer | 3.x | 开源, 笔顺准确 |
| **拼音** | pinyin-pro | 3.x | 支持多音字 |
| **状态管理** | Zustand | 4.x | 轻量, 简单 |
| **API框架** | Next.js API | 14.x | Serverless, 易部署 |
| **缓存** | Redis | 8.x | 高性能 KV 存储 |
| **数据库** | MongoDB | 7.x | 灵活 Schema |
| **AI模型** | DeepSeek | v3 | 性价比高 |
| **部署** | Vercel | - | 自动 CI/CD |

### 2.4 数据库设计

#### MongoDB Collection: `characters`

```javascript
{
  _id: ObjectId("..."),
  char: "猫",                    // 索引字段
  pinyin: "māo",
  pinyin_alternatives: ["máo"], // 多音字
  radical: "犭",
  stroke_count: 11,
  structure: "左右结构",
  
  // AI 生成内容
  ai_content: {
    story: "左边是'犭'代表动物，右边是'苗'，因为猫叫声像'苗'。",
    mnemonic: "反犬旁，苗字边，捉老鼠，它是仙。",
    words: ["小猫", "熊猫", "花猫"],
    sentence: "我家的小猫喜欢在窗台上晒太阳。",
    sentence_pinyin: "wǒ jiā de xiǎo māo xǐ huan zài chuāng tái shàng shài tài yáng.",
    generated_at: ISODate("2025-11-25T10:00:00Z"),
    model: "deepseek-chat"
  },
  
  // 统计数据
  stats: {
    view_count: 105,
    practice_count: 23,
    last_viewed: ISODate("2025-11-25T10:58:00Z")
  },
  
  created_at: ISODate("2025-11-20T10:00:00Z"),
  updated_at: ISODate("2025-11-25T10:58:00Z")
}
```

**索引设计**:
```javascript
db.characters.createIndex({ char: 1 }, { unique: true })
db.characters.createIndex({ "stats.view_count": -1 })
db.characters.createIndex({ created_at: -1 })
```

#### MongoDB Collection: `practice_records`

```javascript
{
  _id: ObjectId("..."),
  user_id: "anonymous_xxx", // 匿名用户
  char: "猫",
  score: 85,                // 准确度评分
  time_spent: 12.5,         // 秒
  mistakes: 2,              // 错误次数
  completed: true,
  created_at: ISODate("2025-11-25T10:58:00Z")
}
```

#### Redis 缓存策略

```
Key 格式: char:{汉字}
Value: JSON 字符串 (MongoDB 数据)
TTL: 604800 秒 (7天)

示例:
Key: "char:猫"
Value: "{\"char\":\"猫\",\"pinyin\":\"māo\",...}"
TTL: 604800
```

### 2.5 API 接口规范

#### GET /api/character

**请求**:
```
GET /api/character?char=猫
```

**响应** (200 OK):
```json
{
  "success": true,
  "data": {
    "char": "猫",
    "pinyin": "māo",
    "radical": "犭",
    "stroke_count": 11,
    "ai_content": {
      "story": "...",
      "mnemonic": "...",
      "words": ["小猫", "熊猫"],
      "sentence": "...",
      "sentence_pinyin": "..."
    }
  },
  "cached": true,
  "timestamp": "2025-11-25T10:58:00Z"
}
```

**错误响应** (400 Bad Request):
```json
{
  "success": false,
  "error": "Invalid character",
  "message": "请输入单个汉字"
}
```

#### POST /api/practice

**请求**:
```json
{
  "char": "猫",
  "score": 85,
  "time_spent": 12.5,
  "mistakes": 2
}
```

**响应**:
```json
{
  "success": true,
  "message": "练习记录已保存",
  "record_id": "674..."
}
```

### 2.6 性能优化策略

| 优化点 | 方案 | 预期效果 |
|-------|------|---------|
| **首屏加载** | Next.js SSR + 代码分割 | FCP < 1.5s |
| **笔画数据** | 本地化 Hanzi Writer 数据 | 加载时间 < 500ms |
| **AI 响应** | 流式输出 (SSE) | 首字延迟 < 1s |
| **缓存命中** | Redis + MongoDB 双层缓存 | 命中率 > 90% |
| **图片优化** | WebP + 懒加载 | 带宽节省 60% |
| **CDN 加速** | Vercel Edge Network | 全球延迟 < 100ms |

### 2.7 安全设计

1. **API 限流**: 每 IP 每分钟最多 30 次请求
2. **输入校验**: 只接受单个汉字 (Unicode 范围: 4E00-9FFF)
3. **SQL 注入防护**: 使用 MongoDB ODM (Mongoose)
4. **XSS 防护**: React 自动转义 + CSP 头
5. **环境变量**: API Key 存储在 Vercel 环境变量

---

## 三、开发路线图

### Phase 1: MVP (第 1-2 周)

**目标**: 实现核心查询和动画功能

- [x] 项目初始化 (Next.js + Tailwind)
- [x] HanziWriter 组件封装
- [x] 搜索框 + 拼音显示
- [x] MongoDB 连接 + Schema 设计
- [x] DeepSeek API 集成
- [x] 缓存机制实现
- [x] 基础 UI 界面

### Phase 2: 完善交互 (第 3 周)

- [ ] TTS 语音播放
- [ ] 练习模式开发
- [ ] 动画效果优化
- [ ] 移动端适配
- [ ] 错误处理 + 加载状态

### Phase 3: 增强功能 (第 4 周)

- [ ] 历史记录 / 生词本
- [ ] AI 插画生成
- [ ] 多字连播模式
- [ ] 数据统计看板
- [ ] 性能优化

### Phase 4: 上线准备 (第 5 周)

- [ ] 单元测试 (Jest)
- [ ] E2E 测试 (Playwright)
- [ ] SEO 优化
- [ ] 部署到 Vercel
- [ ] 监控告警 (Sentry)

---

## 四、部署架构

```
GitHub Repo
    ↓
Vercel CI/CD (自动部署)
    ↓
┌─────────────────────────────┐
│  Vercel Edge Network (CDN)  │
│  - 静态资源 (HTML/CSS/JS)    │
│  - 图片 (WebP)               │
└─────────────────────────────┘
    ↓
┌─────────────────────────────┐
│  Vercel Serverless Function │
│  - Next.js API Routes       │
│  - 动态渲染 (SSR)            │
└─────────────────────────────┘
    ↓
┌──────────────┬──────────────┐
│  Redis       │  MongoDB     │
│  (172.30...) │  (172.30...) │
│  Port: 6379  │  Port: 27017 │
└──────────────┴──────────────┘
```

**环境变量配置** (Vercel):
```env
MONGODB_URI=mongodb://hanzi:hanzi6789@172.30.151.83:27017/hanzi
REDIS_URL=redis://:redis_YT4h4n@172.30.151.83:6379
DEEPSEEK_API_KEY=sk-xxxxx
NEXT_PUBLIC_APP_URL=https://funhanzi.vercel.app
```

---

## 五、监控与运维

### 5.1 关键指标

| 指标 | 目标值 | 监控工具 |
|-----|--------|---------|
| 可用性 | 99.9% | Vercel Analytics |
| 响应时间 (P95) | < 500ms | Vercel Logs |
| 错误率 | < 0.1% | Sentry |
| 缓存命中率 | > 90% | Redis INFO |
| AI 调用成本 | < $10/月 | DeepSeek Dashboard |

### 5.2 日志策略

```javascript
// 结构化日志
{
  timestamp: "2025-11-25T10:58:00Z",
  level: "info",
  service: "api",
  endpoint: "/api/character",
  char: "猫",
  cached: true,
  duration_ms: 45,
  user_ip: "1.2.3.4"
}
```

---

## 附录

### A. 设计资源

- **Figma 设计稿**: [待创建]
- **UI 组件库**: shadcn/ui
- **图标库**: Lucide Icons
- **插画**: AI 生成 (Midjourney/DALL-E)

### B. 参考资料

- Hanzi Writer 文档: https://hanziwriter.org/docs.html
- Next.js 14 文档: https://nextjs.org/docs
- MongoDB Schema 设计: https://www.mongodb.com/docs/manual/data-modeling/
- DeepSeek API: https://platform.deepseek.com/docs

---

**文档结束**
